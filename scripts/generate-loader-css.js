/**
 * Script to extract CSS for each loader
 * Run: node scripts/generate-loader-css.js
 */

const fs = require('fs');
const path = require('path');

const STYLES_DIR = path.join(__dirname, '../src/styles');
const OUTPUT_FILE = path.join(__dirname, '../src/db/loader-css.ts');

const CSS_FILES = [
    'loaders.css',
    'loaders-026-050.css',
    'loaders-051-075.css',
    'loaders-076-100.css',
    'loaders-101-125.css',
    'loaders-126-150.css',
    'loaders-151-175.css',
];

function extractLoaderCSS(cssContent) {
    const loaders = {};
    const lines = cssContent.split('\n');

    let currentId = null;
    let currentCSS = [];

    for (const line of lines) {
        // Check for loader comment like /* 001: Name */ or /* 152: Infinity Loop */
        const commentMatch = line.match(/\/\*\s*(\d{3})\s*:/);

        if (commentMatch) {
            // Save previous loader
            if (currentId && currentCSS.length > 0) {
                loaders[currentId] = currentCSS.join('\n').trim();
            }

            // Start new loader
            currentId = commentMatch[1];
            currentCSS = [];
        } else if (currentId) {
            // Skip header comments like /* ===== */
            if (!line.match(/\/\*\s*=====/)) {
                currentCSS.push(line);
            }
        }
    }

    // Save last loader
    if (currentId && currentCSS.length > 0) {
        loaders[currentId] = currentCSS.join('\n').trim();
    }

    return loaders;
}

function escapeForTemplate(str) {
    return str.replace(/`/g, '\\`').replace(/\$/g, '\\$');
}

function generateOutput(allLoaders) {
    const sortedIds = Object.keys(allLoaders).sort((a, b) => parseInt(a) - parseInt(b));

    let output = `// Auto-generated CSS for all loaders
// Generated by: node scripts/generate-loader-css.js
// Total: ${sortedIds.length} loaders

export const loaderCSS: Record<string, string> = {\n`;

    for (const id of sortedIds) {
        const css = escapeForTemplate(allLoaders[id]);
        output += `  "${id}": \`${css}\`,\n\n`;
    }

    output += `};

// Markdown template
export const getLoaderFullCode = (id: string, name: string, html: string): string => {
    const css = loaderCSS[id] || \`/* CSS for loader-\${id} not found */\`;
    return \`# \${name} Loader (#\${id})

## HTML

\\\`\\\`\\\`html
\${html}
\\\`\\\`\\\`

## CSS

\\\`\\\`\\\`css
\${css}
\\\`\\\`\\\`

---
> ðŸ’¡ Copy both HTML and CSS to your project.
\`;
};
`;

    return output;
}

// Main
console.log('Extracting loader CSS...\n');

const allLoaders = {};

for (const file of CSS_FILES) {
    const filePath = path.join(STYLES_DIR, file);

    if (!fs.existsSync(filePath)) {
        console.log(`âŒ ${file} - not found`);
        continue;
    }

    const content = fs.readFileSync(filePath, 'utf-8');
    const loaders = extractLoaderCSS(content);

    const ids = Object.keys(loaders).sort((a, b) => parseInt(a) - parseInt(b));
    console.log(`âœ“ ${file}: ${ids.length} loaders (${ids[0]}-${ids[ids.length - 1]})`);

    Object.assign(allLoaders, loaders);
}

const allIds = Object.keys(allLoaders).sort((a, b) => parseInt(a) - parseInt(b));
console.log(`\nðŸ“¦ Total: ${allIds.length} loaders (${allIds[0]} to ${allIds[allIds.length - 1]})`);

const output = generateOutput(allLoaders);
fs.writeFileSync(OUTPUT_FILE, output, 'utf-8');

console.log(`âœ… Generated: ${OUTPUT_FILE}`);
